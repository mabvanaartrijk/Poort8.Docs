

# DVU Implementation: enkel gebouw toevoegen vanuit externe datadienst

## Implementatie-instructie Keyper Approve voor DVU datadiensten: Toestemming voor Energiedata van een enkel gebouw via DVU

### Doel

Gebruikers van een applicatie moeten toestemming vragen aan de energiecontractant om energiedata op te halen. Dit gebeurt via een formulier op de website van de applicatie en een achterliggende API-call naar Keyper Approve.

---

### Stap 1: Formulier op de website

#### Velden aanvrager (invullend persoon)

- E-mailadres
- Organisatie
- Organisatie-id (EORI, voorbeeld: EU.EORI.NL860730499)
- Adres aan te vragen gebouw
  - Straatnaam
  - Huisnummer
  - Postcode
  - Plaats

#### Velden energiecontractant (approver via Keyper Approve)

- E-mailadres
- Organisatie
- Organisatie-id (EORI, voorbeeld: EU.EORI.NL860730499)

Client-side validatie verplicht voor e-mail, EORI-nummer en verplichte velden. Helaas ondersteunt DVU op dit moment nog geen KVK nummers.

---

### Stap 2: Aanroepen van de Keyper API

[https://keyper-preview.poort8.nl/scalar/#tag/approval-links/POST/api/approval-links](https://keyper-preview.poort8.nl/scalar/#tag/approval-links/POST/api/approval-links)

Bij formulierverzending stuur je een POST-verzoek naar:

```
POST https://keyper-preview.poort8.nl/api/approval-links
Content-Type: application/json
```

#### JSON-body voorbeeld voor DVU op basis van formulierinvoer

```json
{
  "authenticationMethods": ["eherkenning"],
  "requester": {
    "email": "<EMAIL_AANVRAGER>",
    "organization": "<ORGANISATIE_AANVRAGER>",
    "organizationId": "<EORI_AANVRAGER>"
  },
  "approver": {
    "email": "<EMAIL_ENERGIECONTRACTANT>",
    "organization": "<ORGANISATIE_ENERGIECONTRACTANT>",
    "organizationId": "<EORI_ENERGIECONTRACTANT>"
  },
  "dataspace": {
    "name": "dvu",
    "policyUrl": "https://dvu-test.azurewebsites.net/api/policies/",
    "organizationUrl": "https://dvu-test.azurewebsites.net/api/organization-registry/__ORGANIZATIONID__",
    "resourceGroupUrl": "https://dvu-test.azurewebsites.net/api/resourcegroups/"
  },
  "description": "this keyper approve link was generated by bespaargarant",
  "reference": "<EIGEN_REF>",
  "expiresInSeconds": "<GELDIGHEID>",
  "redirectUrl": "<VERWIJS_URL_EINDE_FLOW>",
  "orchestration": {
    "flow": "dvu.voeg-gebouw-toe@1",
    "payload": {
      "address": "<VOLLEDIG_ADRES>"
    }
  }
}
```

**Gebruikersflow**:
1. Na aanmaken krijgt de applicatie een approval link terug met status "Active"
2. **Voor goedkeuring**: Wanneer de approver de link opent (via redirect), wordt deze automatisch doorgeleid naar DVU metadata-app voor het invoeren van gebouwgegevens
3. **Na metadata invoer**: Gebruiker keert terug naar Keyper Approve voor finale goedkeuring
4. **Na goedkeuring**: Gebruiker wordt doorgeleid naar de `redirectUrl`

**Orchestration-object**:
- **`flow`**: `"dvu.voeg-gebouw-toe@1"` activeert de single building metadata flow
- **`payload.address`**: Het volledige adres van het gebouw (bijv. "Stationsplein 45 3013 AK Rotterdam")
- **`redirectUrl`**: URL waar gebruiker naartoe wordt geleid NA voltooiing van de goedkeuring

**Overig**
- Kies een geldigheid (in seconden) voor hoe lang de link actief is, bijvoorbeeld 1 week (604.800 seconden).
- Gebruik een referentie voor gebruik in de app.

---

### Aandachtspunten

- **Redirect**: wat is de juiste pagina voor afronding of vervolgstap voor de gebruiker? Moet deze terug naar een dashboard, gebouw-koppelscherm of bedankpagina?

- **Testomgeving**: de testomgeving voert **geen volledige verificaties** uit (zoals eHerkenning-authenticatie of validatie van organisatiegegevens). Gebruik dit uitsluitend voor functionele tests.

- Het **orchestration** object is nog in ontwikkeling. Hier worden nog (breaking) changes verwacht.
